<%
layout("/layouts/platform.html"){
%>
<section class="content-wrap bg-white">
    <header class="header navbar bg-white shadow">
        <div class="pull-right offscreen-right">
            <button class="btn btn-primary navbar-btn" onclick="exportFile()" id="exportfile"><i
                    class="fa fa-sliders"></i> 导出
            </button>
            <button class="btn btn-primary navbar-btn" onclick="document.getElementById('xx').click();" id="file"><i
                    class="fa fa-sliders" ></i> 导入
            </button>
            <input type="file" name="xx" id="xx" value="" style="display:none" onchange="importFile(this)"/>
            
        </div>
    </header>
    <div class=panel-body style="padding-top: 50px;">
        <div class="table-responsive no-border">
            <input id="unitid" type="hidden">
            <table class="table table-bordered table-striped mg-t datatable">
                <thead>
                <tr>
                    <th>日期</th>
                    <th>旺旺号</th>
                    <th>收件人</th>
                    <th>固话</th>
                    <th>收件手机</th>
                    <th>收件详细地址</th>
                    <th>托寄物型号</th>
                    <th>尺寸（长宽高）</th>
                    <th>托寄物件数</th>
                    <th>颜色</th>
                    <th>选择发货物流</th>
                    <th>操作</th>
            </table>
        </div>
    </div>
</section>
<!-- 用户详情 -->
<div id="dialogUserDetail" class="modal fade bs-modal-sm" tabindex="-3" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">

        </div>
    </div>
</div>
<div id="dialogUserRightDetail" class="modal fade bs-modal-sm" tabindex="-3" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

        </div>
    </div>
</div>

<script language="JavaScript">
    var datatable;
    function initDatatable() {
        datatable = $('.datatable').DataTable({
            "dom": '<"toolbar">frtip',
            "searching":false,
            "processing": false,
            "serverSide": true,
            "select": true,
            "ordering": true,
            "language": {
                "url": "${base}/assets/plugins/datatables/cn.json"
            },
            "preDrawCallback": function () {
                sublime.showLoadingbar($(".main-content"));
            },
            "drawCallback": function () {
                sublime.closeLoadingbar($(".main-content"));
            },
            "ajax": {
                "url": "${base}/platform/losys/factory/order/data",
                "type": "post",
                "data": function (d) {
                }
            },
            "order": [[0, "desc"]],
            "columns": [
                {"data": "orderdate", "bSortable": true},
                {"data": "account", "bSortable": true},
                {"data": "recipient", "bSortable": true},
                {"data": "fixedtelephone", "bSortable": true},
                {"data": "mobilephone", "bSortable": true},
                {"data": "address", "bSortable": true},
                {"data": "mailingmodel", "bSortable": true},
                {"data": "size", "bSortable": true},
                {"data": "quantity", "bSortable": true},
                {"data": "color", "bSortable": true},
                {"data": "logistics", "bSortable": true},
            ],
            "columnDefs": [
            	{
	                "render": function (data, type, row) {
	                    if (data) {
	                        return moment(parseInt(data)).format("YYYY-MM-DD");
	                    }
	                    return '';
	                },
	                "targets": 0
	            },
	            {
	            	"render": function (data, type, row) {
	            		if(row.orderstatus==1){
                    		return '<div class="btn-group"><button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown">' +
                            ' <i class="ti-settings"></i> <span class="ti-angle-down"></span></button><ul class="dropdown-menu" role="menu">' +
                            '<li class="divider"></li>' +
                            '<li><a href="${base}/platform/losys/factory/order/confirm/' + row.orderid + '" data-toggle="modal" data-target="#homeDetail">确认订单</a></li>' +
                            '</ul></div>';
	            		}else if(row.orderstatus==2){
	            			return '<div class="btn-group"><button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown">' +
                            ' <i class="ti-settings"></i> <span class="ti-angle-down"></span></button><ul class="dropdown-menu" role="menu">' +
                            '<li class="divider"></li>' +
                            '<li><a href="${base}/platform/losys/factory/order/parts/' + row.orderid + '" data-toggle="modal" data-target="#homeDetail">揽件</a></li>' +
                            '</ul></div>';
	            		}else if(row.orderstatus==5){
	            			return '<div class="btn-group"><button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown">' +
                            ' <i class="ti-settings"></i> <span class="ti-angle-down"></span></button><ul class="dropdown-menu" role="menu">' +
                            '<li class="divider"></li>' +
                            '<li><a href="${base}/platform/losys/factory/order/detail' + row.orderid + '" data-pjax data-toggle="modal" data-target="#orderDetail">查看订单状态</a></li>' +
                            '</ul></div>';
	            		}
                    },
	                "targets": 11
	            }
               
            ]
        });
        datatable.on('click', 'tr', function () {
            $(this).toggleClass('selected');
        });
        $("#searchBtn").on('click', function () {
            datatable.ajax.reload();
        });
    }
    function exportFile(){
    	$.post("${base}/platform/losys/taobao/order/exportFile", {}, function (data) {
            if (data.code == 0) {
            	Toast.success(data.msg);
            } else {
                Toast.error(data.msg);
            }
        }, "json");
    }
    
    function importFile(e) {
    	if (!window.File && !window.FileList && !window.FileReader && !window.Blob) {
    		document.write('您的浏览器不支持File Api');
    	}
    	e = e || window.event;
    	var liId = $(e.target).attr("id");
    	var fd = new FormData();
    	fd.append("file", $("#xx")[0].files[0]);
        var fileurl ="${base}/platform/losys/taobao/order/importFile";
    	$.ajax({
    		type : "POST",
    		contentType : false, // 必须false才会避开jQuery对 formdata 的默认处理 ,
    								// XMLHttpRequest会对 formdata 进行正确的处理
    		processData : false, // 必须false才会自动加上正确的Content-Type
            url : fileurl,
    		data : fd,
    		success : function(data) {
    			console.log(data);
    			Toast.success(data.msg);
    			datatable.ajax.reload(null,false);
    		},
    		error : function(msg) {
    			console.log(msg);
    		}
    	});
    }
    $(document).ready(function () {
        initDatatable();
        $('#homeDetail').on('hidden.bs.modal',function(){
            $(this).removeData("bs.modal");
        });
        var name="${@shiro.getPrincipalProperty('nickname')}";
        var id="${@shiro.getPrincipalProperty('id')}";
        console.log(id);
        if(name=="超级管理员"){
        	$("#file").hide();
        }else{
        	$("#addorder").hide();
        	$("#exportfile").hide();
        }
    });

</script>
<%}%>
