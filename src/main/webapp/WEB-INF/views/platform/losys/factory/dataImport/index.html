<%
layout("/layouts/platform.html"){
%>
<section class="content-wrap bg-white">
    <header class="header navbar bg-white shadow">
    	<div class="pull-right offscreen-right">
            <% if (isDisplay != '1') { %>
            	<button class="btn btn-primary navbar-btn" onclick="sublime.toggleFilter('.cd-panel')"><i
	                    class="fa fa-sliders"></i> 筛选
	            </button>
            <% } %>
            <button class="btn btn-primary navbar-btn" onclick="exportFile()" id="exportfile"><i
                    class="fa fa-sliders"></i> 导出
            </button>
        </div>
        
        <% if (isDisplay != '0') { %>
	        <div class="btn-group tool-button">
	            <a id="add" class="btn btn-primary navbar-btn" href="${base}/platform/losys/factory/dataImport/add" data-pjax><i class="ti-plus"></i> 新建数据导入</a>
	            <% if (isDisplay != '1') { %>
	            	<button class="btn btn-danger navbar-btn" onclick="delCheck()"><i class="ti-close"></i> 删除选中</button>
	            <% } %>
	        </div>
	        <div class="btn-group tool-button">
		           <button class="btn btn-primary navbar-btn" id="clickDeliverGoods">发货</button>
	        </div>
        <% } %>
    </header>
    <div class=panel-body style="padding-top: 50px;">
        <div class="table-responsive no-border">
            <table class="table table-bordered table-striped mg-t datatable">
                <thead>
                    <tr>
                            <th>序号</th>
                            <th>日期</th>
                            <th>淘宝店名</th>
                            <th>工厂</th>
                            <th>收件人</th>
                            <th>收件手机</th>
                            <th>收件地址</th>
                            <th>物件内容</th>
                            <th>物件数量</th>
                            <th>物流公司</th>
                            <th>物流单号</th>
                            <th>费用</th>
                            <th>订单状态</th>
                            <th>备注</th>
                            <!-- <th>操作</th> -->
                    </tr>
                </thead>
            </table>
        </div>
    </div>
</section>
<div class="cd-panel from-right">
    <header class="cd-panel-header">
        <h4>高级筛选</h4>
    </header>
    <div class="cd-panel-container">
        <div class="cd-panel-content shadow">
        	<% if (isDisplay == '1') { %>
		        <div class="form-group">
	                <label for="tbName">淘宝名</label>
	                <input type="text" id="tbName" name="tbName" onclick="this.value=''" class="form-control" placeholder="淘宝名" autofocus>
	            </div>
	        <% } %>
            <div class="form-group">
                <label for="factory">工厂</label>
                <input type="text" id="factory" name="factory" onclick="this.value=''" class="form-control" placeholder="工厂" autofocus>
            </div>
            <div class="form-group">
                <label for="addressee">收件人</label>
                <input type="text" id="addressee" name="addressee" onclick="this.value=''" class="form-control" placeholder="收件人">
            </div>
            <div class="form-group">
                <label for="phone">收件手机</label>
                <input type="text" id="phone" name="phone" onclick="this.value=''" class="form-control" placeholder="收件手机">
            </div>
            <div class="form-group">
                <label for="objectContent">物件内容</label>
                <input type="text" id="objectContent" name="objectContent" onclick="this.value=''" class="form-control" placeholder="物件内容">
            </div>
            <div class="form-group">
                <label for="logisticsNo">物流单号</label>
                <input type="text" id="logisticsNo" name="logisticsNo" onclick="this.value=''" class="form-control" placeholder="物流单号">
            </div>
            <div class="form-group">
                <label for="date1">日期起</label>
                <input type="date" id="date1" name="date1" onclick="this.value=''" class="form-control" placeholder="日期">
            </div>
            <div class="form-group">
                <label for="date2">日期止</label>
                <input type="date" id="date2" name="date2" onclick="this.value=''" class="form-control" placeholder="日期">
            </div>
            <button id="searchBtn" type="button" class="btn btn-default">查询</button>
        </div>
    </div>
</div>
<div id="dialogDelete" class="modal fade bs-modal-sm" tabindex="-2" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                <h4 class="modal-title">删除</h4>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-xs-12">
                        删除后无法恢复。<br/>
                        <br/>确定删除吗？
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">取  消</button>
                <button id="okDel" type="button" class="btn btn-primary" data-loading-text="正在删除...">确  定</button>
            </div>
        </div>
    </div>
</div>
<div id="dialogDetail" class="modal fade bs-modal-sm" tabindex="-3" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
        </div>
    </div>
</div>

<!-- 模态框（Modal） -->
<div class="modal fade" id="myModal" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">
					&times;
				</button>
				<h4 class="modal-title" id="myModalLabel">
					发货
				</h4>
			</div>
			<div class="modal-body">
				<input type="text" autofocus="autofocus" class="form-control" id="inputDeliverGoods"  placeholder="请输入">
			</div>
		</div>
	</div>
</div>

<script language="JavaScript">
    var datatable;
    function initDatatable(identification) {
        datatable = $('.datatable').DataTable({
            "dom": '<"toolbar">frtip',
            "bSort": false,
            "searching":false,
            "processing": false,
            "serverSide": true,
            "select": true,
            "ordering": true,
            "language": {
                "url": "${base}/assets/plugins/datatables/cn.json"
            },
            "preDrawCallback": function () {
                sublime.showLoadingbar($(".main-content"));
            },
            "drawCallback": function (data) {
                sublime.closeLoadingbar($(".main-content"));
				
                // update（发货成功） 了数据，弹窗提示
                //if (data.json.identification == 1) {
                //	Toast.success("发货成功");
                //}
            },
            "ajax": {
                "url": "${base}/platform/losys/factory/dataImport/data",
                "type": "post",
                "data": function (d) {
                	d.tbName = $("#tbName").val();
                	d.factory = $("#factory").val();
                    d.addressee = $("#addressee").val();
                    d.phone = $("#phone").val();
                    d.objectContent = $("#objectContent").val();
                    d.date1 = $("#date1").val();
                    d.date2 = $("#date2").val();
                    d.logisticsNo = $("#logisticsNo").val();
                    d.inputDeliverGoods = $("#inputDeliverGoods").val();
                    d.identification = identification;
                }
            },
            "order": [[0, "desc"]],
            "columns": [
                    {"data": "id", "bSortable": true},
                    {"data": "date", "bSortable": true},
                    {"data": "tbName", "bSortable": true},
                    {"data": "factory", "bSortable": true},
                    {"data": "addressee", "bSortable": true},
                    {"data": "phone", "bSortable": true},
                    {"data": "receivingAddress", "bSortable": true},
                    {"data": "objectContent", "bSortable": true},
                    {"data": "objectNumber", "bSortable": true},
                    {"data": "logisticsCompany", "bSortable": true},
                    {"data": "logisticsNo", "bSortable": true},
                    {"data": "money", "bSortable": true},
                    {"data": "status", "bSortable": true},
                    {"data": "remarks", "bSortable": true},
            ],
            /* "aoColumns" :[
                {"sClass" : "center", "mDataProp" : ""}, 
                {"sClass" : "center", "mDataProp" : "date"},
                {"sClass" : "center", "mDataProp" : "tbName"},
                {"sClass" : "center", "mDataProp" : "factory"},
                {"sClass" : "center", "mDataProp" : "addressee"},
                {"sClass" : "center", "mDataProp" : "phone"},
                {"sClass" : "center", "mDataProp" : "receivingAddress"},
                {"sClass" : "center", "mDataProp" : "objectContent"},
                {"sClass" : "center", "mDataProp" : "objectNumber"},
                {"sClass" : "center", "mDataProp" : "logisticsCompany"},
                {"sClass" : "center", "mDataProp" : "logisticsNo"},
                {"sClass" : "center", "mDataProp" : "money"},
                {"sClass" : "center", "mDataProp" : "status"},
                {"sClass" : "center", "mDataProp" : "remarks"},
             ], */
			"fnDrawCallback" : function() {
				var api = this.api();
				var startIndex = api.context[0]._iDisplayStart; 
				api.column(0).nodes().each(function(cell, i) {
					cell.innerHTML = startIndex + i + 1;
				});
			},
		/*  "columnDefs": [
		     {
		         "render": function (data, type, row) {
		             return '<div class="btn-group"><button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown">' +
		                     ' <i class="ti-settings"></i> <span class="ti-angle-down"></span></button><ul class="dropdown-menu" role="menu">' +
		                     '<li><a href="${base}/platform/losys/factory/dataImport/detail/' + row.id + '" data-toggle="modal" data-target="#dialogDetail">查看</a></li>' +
		                     '<li><a href="${base}/platform/losys/factory/dataImport/edit/' + row.id + '" data-pjax>修改</a></li>' +
		                     '<li class="divider"></li>' +
		                     '<li><a href="javascript:;" onclick="del(\'' + row.id + '\')">删除</a></li>' +
		                     '</ul></div>';
		         },
		         "targets": 13
		     }
		 ] */
		});
		datatable.on('click', 'tr', function() {
			$(this).toggleClass('selected');
		});
		$("#searchBtn").on('click', function() {
			datatable.ajax.reload();
		});
	}
	function del(id) {
		var dialog = $("#dialogDelete");
		dialog.modal("show");
		dialog.find("#okDel").unbind("click");
		dialog.find("#okDel").bind(
				"click",
				function(event) {
					var btn = $(this);
					btn.button("loading");
					$.post("${base}/platform/losys/factory/dataImport/delete/"
							+ id, {}, function(data) {
						if (data.code == 0) {
							datatable.ajax.reload(null, false);
						} else {
							Toast.error(data.msg);
						}
						//重置按钮状态，关闭提示框
						btn.button("reset");
						dialog.modal("hide");
					}, "json");
				});
	}
	function delCheck() {
		var chks = datatable.rows('.selected').data();
		if (chks.length > 0) {
			var ids = [];
			$.each(datatable.rows('.selected').data(), function(i, n) {
				ids.push(n.id);
			});
			var dialog = $("#dialogDelete");
			dialog.modal("show");
			dialog.find("#okDel").unbind("click");
			dialog.find("#okDel").bind("click", function(event) {
				var btn = $(this);
				btn.button("loading");
				$.post("${base}/platform/losys/factory/dataImport/delete", {
					ids : ids.toString()
				}, function(data) {
					if (data.code == 0) {
						datatable.ajax.reload(null, false);
					} else {
						Toast.error(data.msg);
					}
					btn.button("reset");
					dialog.modal("hide");
				}, "json");
			});
		} else {
			Toast.warning("请先选择要删除的项！");
		}
	}
	function send() {
		var id = $("#inputDeliverGoods").val();
		$.post("${base}/platform/losys/factory/dataImport/send/" + id, {},
				function(data) {
					if (data.code == 0) {
						$("#inputDeliverGoods").val("");
						Toast.success(data.msg);
						datatable.ajax.reload(null, false);
					} else {
						$("#inputDeliverGoods").val("");
						Toast.error(data.msg);
					}
				}, "json");
	}
	$(function() {
		initDatatable();
		$("#dialogDetail").on("hidden.bs.modal", function() {
			$(this).removeData("bs.modal");
		});
		var timer;
		// 发货弹出层，监听 input 输入
		$("#inputDeliverGoods").bind('input propertychange', function() {
			clearTimeout(timer); //如果操作时已经有了延迟执行, 则取消该延迟执行
			timer = setTimeout(function() { //设定新的延迟执行
				send();
			}, 1000)
		})
	});

	// 点击发货按钮
	$("#clickDeliverGoods").click(function() {//点击按钮
		$("#myModal").modal("show");//打开模态框
		$('#myModal').on('shown.bs.modal', function() {
			$("#myModal #inputDeliverGoods").focus();//获取焦点
		});
	});

	// Excel 数据导出
	function exportFile() {
		var tbName = $('#tbName').val();
		if (typeof tbName === 'undefined' || tbName == '') {
			tbName = "@@";
		}
		var factory = $('#factory').val();
		if (factory == "") {
			factory = "@@"
		}
		var addressee = $('#addressee').val();
		if (addressee == "") {
			addressee = "@@"
		}
		var phone = $('#phone').val();
		if (phone == "") {
			phone = "@@"
		}
		var objectContent = $('#objectContent').val();
		if (objectContent == "") {
			objectContent = "@@"
		}
		var date1 = $('#date1').val();
		if (date1 == "") {
			date1 = "@@"
		}
		var date2 = $('#date2').val();
		if (date2 == "") {
			date2 = "@@"
		}
		var logisticsNo = $('#logisticsNo').val();
		if (logisticsNo == "") {
			logisticsNo = "@@"
		}
        window.location.href = "${base}/platform/losys/factory/dataImport/exportFile/" + tbName + "/ " + factory + " / " + addressee + "/" + phone + "/" + objectContent + "/" + date1 + "/ " + date2 + "/" + logisticsNo;
		// datatable.ajax.reload();
        // window.location.href = "${base}/platform/losys/factory/dataImport/exportFile";
	}
</script>

<%}%>