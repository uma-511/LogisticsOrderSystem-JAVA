<%
layout("/layouts/platform.html"){
%>
<section class="content-wrap bg-white">
	<header class="header navbar bg-white shadow">
		<script language="JavaScript" type="text/javascript"
			src="${base}/assets/plugins/My97DatePicker/WdatePicker.js"></script>
		<div class="btn-group tool-button" id="addorder">
			<a class="btn btn-primary navbar-btn"
				href="${base}/platform/losys/taobao/order/add" data-pjax><i
				class="ti-plus"></i>新建订单</a>
		</div>
		<div class="btn-group tool-button">
			<div class="input-group date form_datetime layoutsSearch"
				style="width: 150px; float: left; padding-left: 5px; padding-right: 5px"
				data-date-format="dd MM yyyy" data-link-field="beginDate">
				<input class="form-control layoutsSearch" type='text' id="beginDate"
					name="beginDate" value='${today!}'
					onFocus="WdatePicker({maxDate:'#F{$dp.$D(\'endDate\')||\'%y-%M-%d\'}'})" />
			</div>
			<div class="input-group date form_datetime layoutsSearch"
				style="width: 150px; float: left; padding-left: 5px; padding-right: 5px"
				data-date-format="dd MM yyyy" data-link-field="endDate">
				<input class="form-control layoutsSearch" type='text' id='endDate' name='endDate'
					value='${today!}'
					onFocus="var date=limitMonthDate(2);WdatePicker({minDate:'#F{$dp.$D(\'beginDate\')||\'${month!}-01\'}',maxDate:date})" />
			</div>
		</div>
		<div class="btn-group tool-button" style="width:45px;">
			<button class="btn btn-primary navbar-btn" onclick="search()">查询</button>
		</div>
		<div class="btn-group tool-button" style="padding-left: 10px;">
			<div class="input-group"
				style="width: 200px; float: left; padding-left: 5px; padding-right: 5px">
				<span class="input-group-addon">订单状态</span> <select id="status"
					class="form-control layoutsSearch" onchange="search()">
					<option value="-1">全部</option>
					<option value="0">未发布</option>
					<option value="1">已发布</option>
					<option value="2">已确认（有货）</option>
					<option value="3">已确认（无货）</option>
					<option value="4">待揽件</option>
					<option value="5">已揽件</option>
					<option value="6">已关闭</option>
				</select>
			</div>
		</div>
		<div class="btn-group tool-button" id="taobao">
			<div class="input-group"
				style="width: 200px; float: left; padding-right: 5px">
				    <span class="input-group-addon">淘宝店主</span> <select id="name"
					class="form-control layoutsSearch" onchange="search()">
					<option value="-1">全部</option>
					<% for(items in obj){%>
					    <option value="${items.id}">${items.loginname}</option>
					<%}%>
				</select>
			</div>
		</div>
		<div class="btn-group tool-button" id="payfor">
			<div class="input-group"
				style="width: 200px; float: left; padding-right: 5px">
				<span class="input-group-addon">支付状态</span> <select id="pay"
					class="form-control layoutsSearch" onchange="search()">
					<option value="-1">全部</option>
					<option value="0">未支付</option>
					<option value="1">已支付</option>
				</select>
			</div>
		</div>
		<div class="btn-group tool-button" style="width:45px;">
			<button class="btn btn-primary navbar-btn" onclick="appintAll()">批量指派</button>
		</div>
		<div class="pull-right offscreen-right">
			<button class="btn btn-primary navbar-btn" onclick="exportFile()"
				id="exportfile">
				<i class="fa fa-sliders"></i> 导出
			</button>
			<button class="btn btn-primary navbar-btn"
				onclick="document.getElementById('xx').click();" id="file">
				<i class="fa fa-sliders"></i> 导入
			</button>
			<input type="file" name="xx" id="xx" value="" style="display: none"
				onchange="importFile(this)" accept="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel"/>
			<div class="btn-group tool-button"></div>
		</div>
	</header>
	<div class=panel-body style="padding-top: 50px;">
		<div class="table-responsive no-border">
			<input id="unitid" type="hidden">
			<table class="table table-bordered table-striped mg-t datatable">
				<thead>
					<tr>
						<th>日期</th>
						<th>买家会员名</th>
						<th>收货人姓名</th>
						<th>联系电话</th>
						<th>联系手机</th>
						<th>收货地址</th>
						<th>托寄物型号</th>
						<th>尺寸（长宽高）</th>
						<th>宝贝总数量</th>
						<th>颜色</th>
						<th>选择发货物流</th>
						<th>单号运费金额</th>
						<th>订单状态</th>
						<th>操作</th>
			</table>
		</div>
	</div>
</section>
<!-- 用户详情 -->
<div id="dialogUserDetail" class="modal fade bs-modal-sm" tabindex="-3" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">

        </div>
    </div>
</div>
<div id="dialogUserRightDetail" class="modal fade bs-modal-sm" tabindex="-3" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

        </div>
    </div>
</div>

<script language="JavaScript">
    var datatable;
    function initDatatable() {
        datatable = $('.datatable').DataTable({
            "dom": '<"toolbar">frtip',
            "searching":false,
            "processing": false,
            "serverSide": true,
            "select": true,
            "ordering": true,
            "language": {
                "url": "${base}/assets/plugins/datatables/cn.json"
            },
            "preDrawCallback": function () {
                sublime.showLoadingbar($(".main-content"));
            },
            "drawCallback": function () {
                sublime.closeLoadingbar($(".main-content"));
            },
            "ajax": {
                "url": "${base}/platform/losys/taobao/order/data",
                "type": "post",
                "data": function (d) {
                	 d.beginDate = $("#beginDate").val();
                     d.endDate = $("#endDate").val();
                     d.status = $("#status").val(); 
                     d.name = $("#name").val(); 
                     d.pay = $("#pay").val(); 
                }
            },
            "order": [[0, "desc"]],
            "columns": [
                {"data": "orderdate", "bSortable": true},
                {"data": "account", "bSortable": true},
                {"data": "recipient", "bSortable": true},
                {"data": "fixedtelephone", "bSortable": true},
                {"data": "mobilephone", "bSortable": true},
                {"data": "address", "bSortable": true},
                {"data": "mailingmodel", "bSortable": true},
                {"data": "size", "bSortable": true},
                {"data": "quantity", "bSortable": true},
                {"data": "color", "bSortable": true},
                {"data": "logistics", "bSortable": true},
                {"data": "freight", "bSortable": true},
                {"data": "orderstatus", "bSortable": true},
            ],
            "columnDefs": [
            	{
	                "render": function (data, type, row) {
	                    if (data) {
	                        return moment(parseInt(data*1000)).format("YYYY-MM-DD");
	                    }
	                    return '';
	                },
	                "targets": 0
	            },
	            {
	                "render": function (data, type, row) {
	                    if (row.orderstatus==1) {
	                        return "已发布";
	                    }else if(row.orderstatus==2){
	                    	return '已确认（有货）';
	                    }else if(row.orderstatus==3){
	                    	return '<span style="color:red;">已确认（无货）</span>';
	                    }else if(row.orderstatus==4){
	                    	return '待揽件';
	                    }else if(row.orderstatus==5){
	                    	return '已揽件';
	                    }else if(row.orderstatus==6){
	                    	return '已关闭';
	                    }
	                    return '未发布';
	                },
	                "targets": 12
	            },
	            {
	            	"render": function (data, type, row) {
	            		if(row.orderstatus==0){
	            			return '<div class="btn-group"><button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown">' +
                            ' <i class="ti-settings"></i> <span class="ti-angle-down"></span></button><ul class="dropdown-menu" role="menu">' +
                            '<li class="divider"></li>' +
                            '<li class="appoint"><a href="${base}/platform/losys/taobao/order/appoint/' + row.orderid + '" data-pjax>指派工厂</a></li>' +
                            '<li><a href="${base}/platform/losys/taobao/order/detail/' + row.orderid + '" data-pjax>查看订单信息</a></li>' +
                            '</ul></div>';
	            		}else{
	            			return '<div class="btn-group"><button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown">' +
                            ' <i class="ti-settings"></i> <span class="ti-angle-down"></span></button><ul class="dropdown-menu" role="menu">' +
                            '<li class="divider"></li>' +
                            '<li><a href="${base}/platform/losys/taobao/order/detail/' + row.orderid + '" data-pjax>查看订单信息</a></li>' +
                            '</ul></div>';
	            		}
                    },
	                "targets": 13
	            }
               
            ]
        });
        datatable.on('click', 'tr', function () {
            $(this).toggleClass('selected');
        });
        $("#searchBtn").on('click', function () {
            datatable.ajax.reload();
        });
    }
    function appintAll(){
    	var Dtable = $('.datatable').DataTable();
    	var ids=Dtable.rows('.selected').data();
    	var id='',status=true;
    	$.each(ids,function (index,items){
    	   id+=items.id+",";
    	   if(items.orderstatus!=0){
    		   status=false;
    	   }
        });
    	var tbid=id.substring(0, id.length - 1);
    	console.log(tbid);
    	if(tbid.length>0){
    		if(status==false){
    			Toast.error("您选择的订单有误!");
    		}else{
    			window.location.href="${base}/platform/losys/taobao/order/appoint/"+tbid;
    		}
    	}else{
    		Toast.error("请选择您想要指派的订单!");
    	}
    }
    function exportFile(){
    	window.location.href="${base}/platform/losys/taobao/order/exportFile/"+$("#beginDate").val()+"/"+$("#endDate").val()+"/"+$("#status").val()+"/"+$("#name").val()+"/"+$("#pay").val()+"";
    }
     //限制开始和结束时间为同一个月
    function limitMonthDate(e) {
        var DateString;
        if (e == 2) {
            var beginDate = $dp.$("beginDate").value;
            if (beginDate != "" && beginDate != null) {
                var limitDate = new Date(beginDate);
                limitDate.setDate(new Date(limitDate.getFullYear(), limitDate
                        .getMonth() + 1, 0).getDate()); //获取此月份的天数
                DateString = limitDate.getFullYear() + '-'
                    + (limitDate.getMonth() + 1) + '-'
                    + limitDate.getDate();
                return DateString;
            }
        }
        if (e == 1) {
            var endDate = $dp.$("endDate").value;
            if (endDate != "" && endDate != null) {
                var limitDate = new Date(endDate);
                limitDate.setDate("1"); //设置闲置时间为月初
                DateString = limitDate.getFullYear() + '-'
                    + (limitDate.getMonth() + 1) + '-'
                    + limitDate.getDate();
                return DateString;
            }
        }

    }
    function importFile(e) {
    	if (!window.File && !window.FileList && !window.FileReader && !window.Blob) {
    		document.write('您的浏览器不支持File Api');
    	}
    	e = e || window.event;
    	var liId = $(e.target).attr("id");
    	var suffix = $("#xx")[0].files[0].name.split(".")[1]
        if(suffix != 'xls' && suffix !='xlsx'){
        	Toast.error("请导入后缀为xlsx,xls的文件!");
            return;
        }
    	var fd = new FormData();
    	fd.append("file", $("#xx")[0].files[0]);
        var fileurl ="${base}/platform/losys/taobao/order/importFile";
    	$.ajax({
    		type : "POST",
    		contentType : false, // 必须false才会避开jQuery对 formdata 的默认处理 ,
    								// XMLHttpRequest会对 formdata 进行正确的处理
    		processData : false, // 必须false才会自动加上正确的Content-Type
            url : fileurl,
    		data : fd,
    		success : function(data) {
    			console.log(data);
    			Toast.success(data.msg);
    			datatable.ajax.reload(null,false);
    		},
    		error : function(msg) {
    			console.log(msg);
    		}
    	});
    }
    function search() {
        datatable.ajax.reload();
    }
    $(document).ready(function () {
        initDatatable();
        $("#dialogUserDetail").on("hidden.bs.modal", function () {
            $(this).removeData("bs.modal");
        });
        $("#dialogUserRightDetail").on("hidden.bs.modal", function () {
            $(this).removeData("bs.modal");
        });
        $("#dialogPaasword").on("hidden.bs.modal", function () {
            $(this).removeData("bs.modal");
        });
        $('#homeDetail').on('hidden.bs.modal',function(){
            $(this).removeData("bs.modal");
        });
        var name="${@shiro.getPrincipalProperty('nickname')}";
        var id="${@shiro.getPrincipalProperty('id')}";
        console.log(id);
        if(name=="超级管理员"){
        	$("#file").hide();
        	$(".appoint").hide();
        }else{
        	$("#taobao").hide();
        	$("#payfor").hide();
        }
        	
    });

</script>
<%}%>
